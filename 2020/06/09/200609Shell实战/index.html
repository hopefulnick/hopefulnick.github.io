<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon32.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon16.jpg?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Shell," />










<meta name="description" content="1./dev/make-distribution.sh --name &quot;hadoop2-without-hive&quot; --tgz &quot;-Pyarn,hadoop-provided,hadoop-2.7,parquet-provided,orc-provided,-Pflume,-Pkubern">
<meta name="keywords" content="Shell">
<meta property="og:type" content="article">
<meta property="og:title" content="Shell实战">
<meta property="og:url" content="https://hopefulnick.github.io/2020/06/09/200609Shell实战/index.html">
<meta property="og:site_name" content="Hopeful Nick">
<meta property="og:description" content="1./dev/make-distribution.sh --name &quot;hadoop2-without-hive&quot; --tgz &quot;-Pyarn,hadoop-provided,hadoop-2.7,parquet-provided,orc-provided,-Pflume,-Pkubernetes&quot;">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-08-30T15:52:41.476Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Shell实战">
<meta name="twitter:description" content="1./dev/make-distribution.sh --name &quot;hadoop2-without-hive&quot; --tgz &quot;-Pyarn,hadoop-provided,hadoop-2.7,parquet-provided,orc-provided,-Pflume,-Pkubernetes&quot;">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://hopefulnick.github.io/2020/06/09/200609Shell实战/"/>





  <title>Shell实战 | Hopeful Nick</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hopeful Nick</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hopefulnick.github.io/2020/06/09/200609Shell实战/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Hopeful Nick">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hopeful Nick">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Shell实战</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-09T11:00:47+08:00">
                2020-06-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Shell/" itemprop="url" rel="index">
                    <span itemprop="name">Shell</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/06/09/200609Shell实战/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/06/09/200609Shell实战/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./dev/make-distribution.sh --name "hadoop2-without-hive" --tgz "-Pyarn,hadoop-provided,hadoop-2.7,parquet-provided,orc-provided,-Pflume,-Pkubernetes"</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/usr/bin/env bash</span><br><span class="line"><span class="meta">#</span> 以上设置Shell环境为Bourne Again Shell</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span> Script to create a binary distribution for easy deploys of Spark.</span><br><span class="line"><span class="meta">#</span> The distribution directory defaults to dist/ but can be overridden below.</span><br><span class="line"><span class="meta">#</span> The distribution contains fat (assembly) jars that include the Scala library,</span><br><span class="line"><span class="meta">#</span> so it is completely self contained.</span><br><span class="line"><span class="meta">#</span> It does not contain source or *.class files.</span><br><span class="line"></span><br><span class="line">set -o pipefail</span><br><span class="line"><span class="meta">#</span> 若指令传回值不等于0，则立即退出shell。</span><br><span class="line">set -e</span><br><span class="line"><span class="meta">#</span> 执行指令后，会先显示该指令及所下的参数</span><br><span class="line">set -x</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 执行pwd指令可立刻得知您目前所在的工作目录的绝对路径名称。</span><br><span class="line"><span class="meta">#</span> Figure out where the Spark framework is installed</span><br><span class="line">SPARK_HOME="$(cd "`dirname "$0"`/.."; pwd)"</span><br><span class="line">DISTDIR="$SPARK_HOME/dist"</span><br><span class="line"></span><br><span class="line">MAKE_TGZ=false</span><br><span class="line">MAKE_PIP=false</span><br><span class="line">MAKE_R=false</span><br><span class="line">NAME=none</span><br><span class="line">MVN="$SPARK_HOME/build/mvn"</span><br><span class="line"></span><br><span class="line">function exit_with_usage &#123;</span><br><span class="line"><span class="meta">#</span> 取消参数显式</span><br><span class="line">  set +x</span><br><span class="line">  echo "make-distribution.sh - tool for making binary distributions of Spark"</span><br><span class="line">  echo ""</span><br><span class="line">  echo "usage:"</span><br><span class="line">  cl_options="[--name] [--tgz] [--pip] [--r] [--mvn &lt;mvn-command&gt;]"</span><br><span class="line">  echo "make-distribution.sh $cl_options &lt;maven build options&gt;"</span><br><span class="line">  echo "See Spark's \"Building Spark\" doc for correct Maven options."</span><br><span class="line">  echo ""</span><br><span class="line"><span class="meta">  #</span> 非正常返回</span><br><span class="line">  exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Parse arguments</span><br><span class="line"><span class="meta">#</span> $# 传递脚本或函数参数</span><br><span class="line">while (( "$#" )); do</span><br><span class="line">  case $1 in</span><br><span class="line">    --tgz)</span><br><span class="line">      MAKE_TGZ=true</span><br><span class="line">      # break</span><br><span class="line">      ;;</span><br><span class="line">    --pip)</span><br><span class="line">      MAKE_PIP=true</span><br><span class="line">      ;;</span><br><span class="line">    --r)</span><br><span class="line">      MAKE_R=true</span><br><span class="line">      ;;</span><br><span class="line">    --mvn)</span><br><span class="line">      MVN="$2"</span><br><span class="line">      # 位置参数左移一位</span><br><span class="line">      # 效果是$1失效，其余变量下标-1</span><br><span class="line">      shift</span><br><span class="line">      ;;</span><br><span class="line">    --name)</span><br><span class="line">      NAME="$2"</span><br><span class="line">      shift</span><br><span class="line">      ;;</span><br><span class="line">    --help)</span><br><span class="line">      exit_with_usage</span><br><span class="line">      ;;</span><br><span class="line">    --*)</span><br><span class="line">      echo "Error: $1 is not supported"</span><br><span class="line">      exit_with_usage</span><br><span class="line">      ;;</span><br><span class="line">    -*)</span><br><span class="line">      break</span><br><span class="line">      ;;</span><br><span class="line">      # default</span><br><span class="line">    *)</span><br><span class="line">      echo "Error: $1 is not supported"</span><br><span class="line">      exit_with_usage</span><br><span class="line">      ;;</span><br><span class="line">  esac</span><br><span class="line">  shift</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">if [ -z "$JAVA_HOME" ]; then</span><br><span class="line"><span class="meta">  #</span> Fall back on JAVA_HOME from rpm, if found</span><br><span class="line"><span class="meta">  #</span> command 判断命令是否存在</span><br><span class="line">  if [ $(command -v  rpm) ]; then</span><br><span class="line"><span class="meta">  #</span> rpm -E卸载套件</span><br><span class="line">    RPM_JAVA_HOME="$(rpm -E %java_home 2&gt;/dev/null)"</span><br><span class="line">    if [ "$RPM_JAVA_HOME" != "%java_home" ]; then</span><br><span class="line">      JAVA_HOME="$RPM_JAVA_HOME"</span><br><span class="line">      echo "No JAVA_HOME set, proceeding with '$JAVA_HOME' learned from rpm"</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [ -z "$JAVA_HOME" ]; then</span><br><span class="line">    if [ `command -v java` ]; then</span><br><span class="line">      # If java is in /usr/bin/java, we want /usr</span><br><span class="line">      # which输出文件绝对路径</span><br><span class="line">      # 嵌套两个dirname取java文件的祖父目录/usr</span><br><span class="line">      JAVA_HOME="$(dirname $(dirname $(which java)))"</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ -z "$JAVA_HOME" ]; then</span><br><span class="line">  echo "Error: JAVA_HOME is not set, cannot proceed."</span><br><span class="line">  exit -1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ $(command -v git) ]; then</span><br><span class="line"><span class="meta">#</span> 获取最新commit id</span><br><span class="line">    GITREV=$(git rev-parse --short HEAD 2&gt;/dev/null || :)</span><br><span class="line">    if [ ! -z "$GITREV" ]; then</span><br><span class="line">    # 设置字符串，没有revision指令</span><br><span class="line">        GITREVSTRING=" (git revision $GITREV)"</span><br><span class="line">    fi</span><br><span class="line">    unset GITREV</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if [ ! "$(command -v "$MVN")" ] ; then</span><br><span class="line">    echo -e "Could not locate Maven command: '$MVN'."</span><br><span class="line">    echo -e "Specify the Maven command with the --mvn flag"</span><br><span class="line">    exit -1;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 获取版本信息，使用mvn help:evaluate插件</span><br><span class="line"><span class="meta">#</span> 使用内嵌的mvn脚本执行，可能安装mvn、scala和zinc</span><br><span class="line"><span class="meta">#</span> 在Soft Quota中，$@以字符串列表返回所有参数，$#以单个字符串返回所有参数</span><br><span class="line"><span class="meta">#</span> |前面命令成功后才继续执行</span><br><span class="line"><span class="meta">#</span> grep -v显式不包含正则的所有行</span><br><span class="line">VERSION=$("$MVN" help:evaluate -Dexpression=project.version $@ \</span><br><span class="line">    | grep -v "INFO"\</span><br><span class="line">    | grep -v "WARNING"\</span><br><span class="line">    # 取首行</span><br><span class="line">    | tail -n 1)</span><br><span class="line">SCALA_VERSION=$("$MVN" help:evaluate -Dexpression=scala.binary.version $@ \</span><br><span class="line">    | grep -v "INFO"\</span><br><span class="line">    | grep -v "WARNING"\</span><br><span class="line">    | tail -n 1)</span><br><span class="line">SPARK_HADOOP_VERSION=$("$MVN" help:evaluate -Dexpression=hadoop.version $@ \</span><br><span class="line">    | grep -v "INFO"\</span><br><span class="line">    | grep -v "WARNING"\</span><br><span class="line">    | tail -n 1)</span><br><span class="line"><span class="meta">#</span> fgrep用于查找文件里符合条件的字符，相当于grep -f</span><br><span class="line"><span class="meta">#</span> echo -n不换行输出</span><br><span class="line">SPARK_HIVE=$("$MVN" help:evaluate -Dexpression=project.activeProfiles -pl sql/hive $@ \</span><br><span class="line">    | grep -v "INFO"\</span><br><span class="line">    | grep -v "WARNING"\</span><br><span class="line">    | fgrep --count "&lt;id&gt;hive&lt;/id&gt;";\</span><br><span class="line">    # Reset exit status to 0, otherwise the script stops here if the last grep finds nothing\</span><br><span class="line">    # because we use "set -o pipefail"</span><br><span class="line">    echo -n)</span><br><span class="line"></span><br><span class="line">if [ "$NAME" == "none" ]; then</span><br><span class="line">  NAME=$SPARK_HADOOP_VERSION</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo "Spark version is $VERSION"</span><br><span class="line"></span><br><span class="line">if [ "$MAKE_TGZ" == "true" ]; then</span><br><span class="line">  echo "Making spark-$VERSION-bin-$NAME.tgz"</span><br><span class="line">else</span><br><span class="line">  echo "Making distribution for Spark $VERSION in '$DISTDIR'..."</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Build uber fat JAR</span><br><span class="line">cd "$SPARK_HOME"</span><br><span class="line"></span><br><span class="line">export MAVEN_OPTS="$&#123;MAVEN_OPTS:--Xmx2g -XX:ReservedCodeCacheSize=1g&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 由于双引号内视为文本，参数引用和单引号也一视同仁</span><br><span class="line"><span class="meta">#</span> Store the command as an array because $MVN variable might have spaces in it.</span><br><span class="line"><span class="meta">#</span> Normal quoting tricks don't work.</span><br><span class="line"><span class="meta">#</span> See: http://mywiki.wooledge.org/BashFAQ/050</span><br><span class="line">BUILD_COMMAND=("$MVN" clean package -DskipTests $@)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Actually build the jar</span><br><span class="line">echo -e "\nBuilding with..."</span><br><span class="line">echo -e "\$ $&#123;BUILD_COMMAND[@]&#125;\n"</span><br><span class="line"></span><br><span class="line">"$&#123;BUILD_COMMAND[@]&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Make directories</span><br><span class="line">rm -rf "$DISTDIR"</span><br><span class="line">mkdir -p "$DISTDIR/jars"</span><br><span class="line"><span class="meta">#</span> &gt;清空后添加，&gt;&gt;追加</span><br><span class="line">echo "Spark $VERSION$GITREVSTRING built for Hadoop $SPARK_HADOOP_VERSION" &gt; "$DISTDIR/RELEASE"</span><br><span class="line">echo "Build flags: $@" &gt;&gt; "$DISTDIR/RELEASE"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Copy jars</span><br><span class="line">cp "$SPARK_HOME"/assembly/target/scala*/jars/* "$DISTDIR/jars/"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Only create the yarn directory if the yarn artifacts were built.</span><br><span class="line">if [ -f "$SPARK_HOME"/common/network-yarn/target/scala*/spark-*-yarn-shuffle.jar ]; then</span><br><span class="line">  mkdir "$DISTDIR/yarn"</span><br><span class="line">  cp "$SPARK_HOME"/common/network-yarn/target/scala*/spark-*-yarn-shuffle.jar "$DISTDIR/yarn"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Only create and copy the dockerfiles directory if the kubernetes artifacts were built.</span><br><span class="line">if [ -d "$SPARK_HOME"/resource-managers/kubernetes/core/target/ ]; then</span><br><span class="line">  mkdir -p "$DISTDIR/kubernetes/"</span><br><span class="line"><span class="meta">  #</span> cp -a在复制时保留链接和文件属性等，相当于dpR</span><br><span class="line">  cp -a "$SPARK_HOME"/resource-managers/kubernetes/docker/src/main/dockerfiles "$DISTDIR/kubernetes/"</span><br><span class="line">  cp -a "$SPARK_HOME"/resource-managers/kubernetes/integration-tests/tests "$DISTDIR/kubernetes/"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Copy examples and dependencies</span><br><span class="line">mkdir -p "$DISTDIR/examples/jars"</span><br><span class="line">cp "$SPARK_HOME"/examples/target/scala*/jars/* "$DISTDIR/examples/jars"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Deduplicate jars that have already been packaged as part of the main Spark dependencies.</span><br><span class="line">for f in "$DISTDIR"/examples/jars/*; do</span><br><span class="line"><span class="meta">#</span> basename去除文件路径，只保留文件名.后缀，相当于$&#123;var##*/&#125;</span><br><span class="line"><span class="meta">#</span> dirname去除文件名.后缀，只保留路径，相当于$&#123;var%/*&#125;</span><br><span class="line">  name=$(basename "$f")</span><br><span class="line">  if [ -f "$DISTDIR/jars/$name" ]; then</span><br><span class="line">    rm "$DISTDIR/examples/jars/$name"</span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Copy example sources (needed for python and SQL)</span><br><span class="line">mkdir -p "$DISTDIR/examples/src/main"</span><br><span class="line"><span class="meta">#</span> cp -r若为目录，递归复制子文件和文件夹</span><br><span class="line">cp -r "$SPARK_HOME/examples/src/main" "$DISTDIR/examples/src/"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Copy license and ASF files</span><br><span class="line"><span class="meta">#</span> -e 文件存在，-f 常规文件存在</span><br><span class="line">if [ -e "$SPARK_HOME/LICENSE-binary" ]; then</span><br><span class="line">  cp "$SPARK_HOME/LICENSE-binary" "$DISTDIR/LICENSE"</span><br><span class="line">  cp -r "$SPARK_HOME/licenses-binary" "$DISTDIR/licenses"</span><br><span class="line">  cp "$SPARK_HOME/NOTICE-binary" "$DISTDIR/NOTICE"</span><br><span class="line">else</span><br><span class="line">  echo "Skipping copying LICENSE files"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ -e "$SPARK_HOME/CHANGES.txt" ]; then</span><br><span class="line">  cp "$SPARK_HOME/CHANGES.txt" "$DISTDIR"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Copy data files</span><br><span class="line">cp -r "$SPARK_HOME/data" "$DISTDIR"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Make pip package</span><br><span class="line">if [ "$MAKE_PIP" == "true" ]; then</span><br><span class="line">  echo "Building python distribution package"</span><br><span class="line"><span class="meta">  #</span> pushd 切换到目录并以栈的形式保存，默认还会执行一个dirs命令输出当前目录元素</span><br><span class="line"><span class="meta">  #</span> 目录栈的栈顶始终是当前目录，反之亦然</span><br><span class="line">  pushd "$SPARK_HOME/python" &gt; /dev/null</span><br><span class="line"><span class="meta">  #</span> Delete the egg info file if it exists, this can cache older setup files.</span><br><span class="line">  rm -rf pyspark.egg-info || echo "No existing egg info file, skipping deletion"</span><br><span class="line">  python3 setup.py sdist</span><br><span class="line"><span class="meta">  #</span> popd弹出栈顶元素，并切换到新的栈顶，模型执行一个dirs命令</span><br><span class="line">  popd &gt; /dev/null</span><br><span class="line">else</span><br><span class="line">  echo "Skipping building python distribution package"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Make R package - this is used for both CRAN release and packing R layout into distribution</span><br><span class="line">if [ "$MAKE_R" == "true" ]; then</span><br><span class="line">  echo "Building R source package"</span><br><span class="line"><span class="meta">  #</span> grep -V 显示版本信息</span><br><span class="line"><span class="meta">  #</span> awk 文本分析工具，如awk '&#123;print $NF&#125;'打印最后一个参数</span><br><span class="line"><span class="meta">  #</span> $NF 最后一个参数</span><br><span class="line">  R_PACKAGE_VERSION=`grep Version "$SPARK_HOME/R/pkg/DESCRIPTION" | awk '&#123;print $NF&#125;'`</span><br><span class="line">  pushd "$SPARK_HOME/R" &gt; /dev/null</span><br><span class="line"><span class="meta">  #</span> Build source package and run full checks</span><br><span class="line"><span class="meta">  #</span> Do not source the check-cran.sh - it should be run from where it is for it to set SPARK_HOME</span><br><span class="line">  NO_TESTS=1 "$SPARK_HOME/R/check-cran.sh"</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span> Move R source package to match the Spark release version if the versions are not the same.</span><br><span class="line"><span class="meta">  #</span> NOTE(shivaram): `mv` throws an error on Linux if source and destination are same file</span><br><span class="line">  if [ "$R_PACKAGE_VERSION" != "$VERSION" ]; then</span><br><span class="line">    mv "$SPARK_HOME/R/SparkR_$R_PACKAGE_VERSION.tar.gz" "$SPARK_HOME/R/SparkR_$VERSION.tar.gz"</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span> Install source package to get it to generate vignettes rds files, etc.</span><br><span class="line">  VERSION=$VERSION "$SPARK_HOME/R/install-source-package.sh"</span><br><span class="line">  popd &gt; /dev/null</span><br><span class="line">else</span><br><span class="line">  echo "Skipping building R source package"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Copy other things</span><br><span class="line">mkdir "$DISTDIR/conf"</span><br><span class="line">cp "$SPARK_HOME"/conf/*.template "$DISTDIR/conf"</span><br><span class="line">cp "$SPARK_HOME/README.md" "$DISTDIR"</span><br><span class="line">cp -r "$SPARK_HOME/bin" "$DISTDIR"</span><br><span class="line">cp -r "$SPARK_HOME/python" "$DISTDIR"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Remove the python distribution from dist/ if we built it</span><br><span class="line">if [ "$MAKE_PIP" == "true" ]; then</span><br><span class="line">  rm -f "$DISTDIR"/python/dist/pyspark-*.tar.gz</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">cp -r "$SPARK_HOME/sbin" "$DISTDIR"</span><br><span class="line"><span class="meta">#</span> Copy SparkR if it exists</span><br><span class="line">if [ -d "$SPARK_HOME/R/lib/SparkR" ]; then</span><br><span class="line">  mkdir -p "$DISTDIR/R/lib"</span><br><span class="line">  cp -r "$SPARK_HOME/R/lib/SparkR" "$DISTDIR/R/lib"</span><br><span class="line">  cp "$SPARK_HOME/R/lib/sparkr.zip" "$DISTDIR/R/lib"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ "$MAKE_TGZ" == "true" ]; then</span><br><span class="line">  TARDIR_NAME=spark-$VERSION-bin-$NAME</span><br><span class="line">  TARDIR="$SPARK_HOME/$TARDIR_NAME"</span><br><span class="line">  rm -rf "$TARDIR"</span><br><span class="line">  cp -r "$DISTDIR" "$TARDIR"</span><br><span class="line">  tar czf "spark-$VERSION-bin-$NAME.tgz" -C "$SPARK_HOME" "$TARDIR_NAME"</span><br><span class="line">  rm -rf "$TARDIR"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>mvn</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> Determine the current working directory</span><br><span class="line">_DIR="$( cd "$( dirname "$&#123;BASH_SOURCE[0]&#125;" )" &amp;&amp; pwd )"</span><br><span class="line"><span class="meta">#</span> Preserve the calling directory</span><br><span class="line">_CALLING_DIR="$(pwd)"</span><br><span class="line"><span class="meta">#</span> Options used during compilation</span><br><span class="line">_COMPILE_JVM_OPTS="-Xmx2g -XX:ReservedCodeCacheSize=1g"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Installs any application tarball given a URL, the expected tarball name,</span><br><span class="line"><span class="meta">#</span> and, optionally, a checkable binary path to determine if the binary has</span><br><span class="line"><span class="meta">#</span> already been installed</span><br><span class="line"><span class="meta">#</span># Arg1 - URL</span><br><span class="line"><span class="meta">#</span># Arg2 - Tarball Name</span><br><span class="line"><span class="meta">#</span># Arg3 - Checkable Binary</span><br><span class="line">install_app() &#123;</span><br><span class="line"><span class="meta">#</span># 声明局部变量</span><br><span class="line">  local remote_tarball="$1/$2"</span><br><span class="line">  local local_tarball="$&#123;_DIR&#125;/$2"</span><br><span class="line">  local binary="$&#123;_DIR&#125;/$3"</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span># curl -L 支持网页重定向</span><br><span class="line">  local curl_opts="--silent --show-error -L"</span><br><span class="line"><span class="meta">  #</span># wget --no-verbose关闭详尽输出，但不静默</span><br><span class="line">  local wget_opts="--no-verbose"</span><br><span class="line"><span class="meta">	#</span># -z 字符串是否长度为0</span><br><span class="line"><span class="meta">	#</span># -o 或</span><br><span class="line"><span class="meta">	#</span># ! 非</span><br><span class="line">  if [ -z "$3" -o ! -f "$binary" ]; then</span><br><span class="line">    # check if we already have the tarball</span><br><span class="line">    # check if we have curl installed</span><br><span class="line">    # download application</span><br><span class="line">    [ ! -f "$&#123;local_tarball&#125;" ] &amp;&amp; [ $(command -v curl) ] &amp;&amp; \</span><br><span class="line">      echo "exec: curl $&#123;curl_opts&#125; $&#123;remote_tarball&#125;" 1&gt;&amp;2 &amp;&amp; \</span><br><span class="line">      curl $&#123;curl_opts&#125; "$&#123;remote_tarball&#125;" &gt; "$&#123;local_tarball&#125;"</span><br><span class="line">    # if the file still doesn't exist, lets try `wget` and cross our fingers</span><br><span class="line">    [ ! -f "$&#123;local_tarball&#125;" ] &amp;&amp; [ $(command -v wget) ] &amp;&amp; \</span><br><span class="line">      echo "exec: wget $&#123;wget_opts&#125; $&#123;remote_tarball&#125;" 1&gt;&amp;2 &amp;&amp; \</span><br><span class="line">      wget $&#123;wget_opts&#125; -O "$&#123;local_tarball&#125;" "$&#123;remote_tarball&#125;"</span><br><span class="line">    # if both were unsuccessful, exit</span><br><span class="line">    [ ! -f "$&#123;local_tarball&#125;" ] &amp;&amp; \</span><br><span class="line">      echo -n "ERROR: Cannot download $2 with cURL or wget; " &amp;&amp; \</span><br><span class="line">      echo "please install manually and try again." &amp;&amp; \</span><br><span class="line">      exit 2</span><br><span class="line">    cd "$&#123;_DIR&#125;" &amp;&amp; tar -xzf "$2"</span><br><span class="line">    rm -rf "$local_tarball"</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> See simple version normalization: http://stackoverflow.com/questions/16989598/bash-comparing-version-numbers</span><br><span class="line">function version &#123; echo "$@" | awk -F. '&#123; printf("%03d%03d%03d\n", $1,$2,$3); &#125;'; &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Determine the Maven version from the root pom.xml file and</span><br><span class="line"><span class="meta">#</span> install maven under the build/ folder if needed.</span><br><span class="line">install_mvn() &#123;</span><br><span class="line">  local MVN_VERSION=`grep "&lt;maven.version&gt;" "$&#123;_DIR&#125;/../pom.xml" | head -n1 | awk -F '[&lt;&gt;]' '&#123;print $3&#125;'`</span><br><span class="line">  MVN_BIN="$(command -v mvn)"</span><br><span class="line">  if [ "$MVN_BIN" ]; then</span><br><span class="line">    local MVN_DETECTED_VERSION="$(mvn --version | head -n1 | awk '&#123;print $3&#125;')"</span><br><span class="line">  fi</span><br><span class="line">  if [ $(version $MVN_DETECTED_VERSION) -lt $(version $MVN_VERSION) ]; then</span><br><span class="line">    local APACHE_MIRROR=$&#123;APACHE_MIRROR:-'https://www.apache.org/dyn/closer.lua?action=download&amp;filename='&#125;</span><br><span class="line">        </span><br><span class="line">    if [ $(command -v curl) ]; then</span><br><span class="line">      local TEST_MIRROR_URL="$&#123;APACHE_MIRROR&#125;/maven/maven-3/$&#123;MVN_VERSION&#125;/binaries/apache-maven-$&#123;MVN_VERSION&#125;-bin.tar.gz"</span><br><span class="line">      if ! curl -L --output /dev/null --silent --head --fail "$TEST_MIRROR_URL" ; then</span><br><span class="line">        # Fall back to archive.apache.org for older Maven</span><br><span class="line">        echo "Falling back to archive.apache.org to download Maven"</span><br><span class="line">        APACHE_MIRROR="https://archive.apache.org/dist"</span><br><span class="line">      fi</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    install_app \</span><br><span class="line">      "$&#123;APACHE_MIRROR&#125;/maven/maven-3/$&#123;MVN_VERSION&#125;/binaries" \</span><br><span class="line">      "apache-maven-$&#123;MVN_VERSION&#125;-bin.tar.gz" \</span><br><span class="line">      "apache-maven-$&#123;MVN_VERSION&#125;/bin/mvn"</span><br><span class="line"></span><br><span class="line">    MVN_BIN="$&#123;_DIR&#125;/apache-maven-$&#123;MVN_VERSION&#125;/bin/mvn"</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Install zinc under the build/ folder</span><br><span class="line">install_zinc() &#123;</span><br><span class="line">  local ZINC_VERSION=0.3.15</span><br><span class="line">  ZINC_BIN="$(command -v zinc)"</span><br><span class="line">  if [ "$ZINC_BIN" ]; then</span><br><span class="line">    local ZINC_DETECTED_VERSION="$(zinc -version | head -n1 | awk '&#123;print $5&#125;')"</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [ $(version $ZINC_DETECTED_VERSION) -lt $(version $ZINC_VERSION) ]; then</span><br><span class="line">    local zinc_path="zinc-$&#123;ZINC_VERSION&#125;/bin/zinc"</span><br><span class="line">    [ ! -f "$&#123;_DIR&#125;/$&#123;zinc_path&#125;" ] &amp;&amp; ZINC_INSTALL_FLAG=1</span><br><span class="line">    local TYPESAFE_MIRROR=$&#123;TYPESAFE_MIRROR:-https://downloads.lightbend.com&#125;</span><br><span class="line"></span><br><span class="line">    install_app \</span><br><span class="line">      "$&#123;TYPESAFE_MIRROR&#125;/zinc/$&#123;ZINC_VERSION&#125;" \</span><br><span class="line">      "zinc-$&#123;ZINC_VERSION&#125;.tgz" \</span><br><span class="line">      "$&#123;zinc_path&#125;"</span><br><span class="line">    ZINC_BIN="$&#123;_DIR&#125;/$&#123;zinc_path&#125;"</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Determine the Scala version from the root pom.xml file, set the Scala URL,</span><br><span class="line"><span class="meta">#</span> and, with that, download the specific version of Scala necessary under</span><br><span class="line"><span class="meta">#</span> the build/ folder</span><br><span class="line">install_scala() &#123;</span><br><span class="line"><span class="meta">  #</span> determine the Scala version used in Spark</span><br><span class="line">  local scala_binary_version=`grep "scala.binary.version" "$&#123;_DIR&#125;/../pom.xml" | head -n1 | awk -F '[&lt;&gt;]' '&#123;print $3&#125;'`</span><br><span class="line">  local scala_version=`grep "scala.version" "$&#123;_DIR&#125;/../pom.xml" | grep $&#123;scala_binary_version&#125; | head -n1 | awk -F '[&lt;&gt;]' '&#123;print $3&#125;'`</span><br><span class="line">  local scala_bin="$&#123;_DIR&#125;/scala-$&#123;scala_version&#125;/bin/scala"</span><br><span class="line">  local TYPESAFE_MIRROR=$&#123;TYPESAFE_MIRROR:-https://downloads.lightbend.com&#125;</span><br><span class="line"></span><br><span class="line">  install_app \</span><br><span class="line">    "$&#123;TYPESAFE_MIRROR&#125;/scala/$&#123;scala_version&#125;" \</span><br><span class="line">    "scala-$&#123;scala_version&#125;.tgz" \</span><br><span class="line">    "scala-$&#123;scala_version&#125;/bin/scala"</span><br><span class="line"></span><br><span class="line">  SCALA_COMPILER="$(cd "$(dirname "$&#123;scala_bin&#125;")/../lib" &amp;&amp; pwd)/scala-compiler.jar"</span><br><span class="line">  SCALA_LIBRARY="$(cd "$(dirname "$&#123;scala_bin&#125;")/../lib" &amp;&amp; pwd)/scala-library.jar"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Setup healthy defaults for the Zinc port if none were provided from</span><br><span class="line"><span class="meta">#</span> the environment</span><br><span class="line">ZINC_PORT=$&#123;ZINC_PORT:-"3030"&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Install the proper version of Scala, Zinc and Maven for the build</span><br><span class="line">install_zinc</span><br><span class="line">install_scala</span><br><span class="line">install_mvn</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Reset the current working directory</span><br><span class="line">cd "$&#123;_CALLING_DIR&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Now that zinc is ensured to be installed, check its status and, if its</span><br><span class="line"><span class="meta">#</span> not running or just installed, start it</span><br><span class="line">if [ -n "$&#123;ZINC_INSTALL_FLAG&#125;" -o -z "`"$&#123;ZINC_BIN&#125;" -status -port $&#123;ZINC_PORT&#125;`" ]; then</span><br><span class="line">  export ZINC_OPTS=$&#123;ZINC_OPTS:-"$_COMPILE_JVM_OPTS"&#125;</span><br><span class="line">  "$&#123;ZINC_BIN&#125;" -shutdown -port $&#123;ZINC_PORT&#125;</span><br><span class="line">  "$&#123;ZINC_BIN&#125;" -start -port $&#123;ZINC_PORT&#125; \</span><br><span class="line">    -server 127.0.0.1 -idle-timeout 3h \</span><br><span class="line">    -scala-compiler "$&#123;SCALA_COMPILER&#125;" \</span><br><span class="line">    -scala-library "$&#123;SCALA_LIBRARY&#125;" &amp;&gt;/dev/null</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Set any `mvn` options if not already present</span><br><span class="line">export MAVEN_OPTS=$&#123;MAVEN_OPTS:-"$_COMPILE_JVM_OPTS"&#125;</span><br><span class="line"></span><br><span class="line">echo "Using \`mvn\` from path: $MVN_BIN" 1&gt;&amp;2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> call the `mvn` command as usual</span><br><span class="line"><span class="meta">#</span> SPARK-25854</span><br><span class="line">"$&#123;MVN_BIN&#125;" -DzincPort=$&#123;ZINC_PORT&#125; "$@"</span><br><span class="line">MVN_RETCODE=$?</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Try to shut down zinc explicitly if the server is still running.</span><br><span class="line">"$&#123;ZINC_BIN&#125;" -shutdown -port $&#123;ZINC_PORT&#125;</span><br><span class="line"></span><br><span class="line">exit $MVN_RETCODE</span><br></pre></td></tr></table></figure>
<p>shell变量分为global和local两种。</p>
<p>global默认作用域为整个脚本，除非显式删除。</p>
<p>local作用域为函数内部，且在同名时优先。</p>
<p>curl和wget均可用于访问网页内容，但curl可以自定义请求参数等，擅长模拟浏览器活动；而wget支持ftp和Recursive，擅长文件下载。</p>
<p>stop-yarn.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/usr/bin/env bash</span><br><span class="line"></span><br><span class="line">function hadoop_usage</span><br><span class="line">&#123;</span><br><span class="line">  hadoop_generate_usage "$&#123;MYNAME&#125;" false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> BASH_SOURCE取当前执行脚本路径</span><br><span class="line">MYNAME="$&#123;BASH_SOURCE-$0&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> cd -P到软链接的原始目录，cd -L默认方式到文件所在目录，不处理软链接</span><br><span class="line"><span class="meta">#</span> pwd -P同上</span><br><span class="line">bin=$(cd -P -- "$(dirname -- "$&#123;MYNAME&#125;")" &gt;/dev/null &amp;&amp; pwd -P)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> let's locate libexec...</span><br><span class="line">if [[ -n "$&#123;HADOOP_HOME&#125;" ]]; then</span><br><span class="line">  HADOOP_DEFAULT_LIBEXEC_DIR="$&#123;HADOOP_HOME&#125;/libexec"</span><br><span class="line">else</span><br><span class="line">  HADOOP_DEFAULT_LIBEXEC_DIR="$&#123;bin&#125;/../libexec"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> :-使用后者作为前者的缺省值</span><br><span class="line">HADOOP_LIBEXEC_DIR="$&#123;HADOOP_LIBEXEC_DIR:-$HADOOP_DEFAULT_LIBEXEC_DIR&#125;"</span><br><span class="line"><span class="meta">#</span> shellcheck disable=SC2034</span><br><span class="line">HADOOP_NEW_CONFIG=true</span><br><span class="line">if [[ -f "$&#123;HADOOP_LIBEXEC_DIR&#125;/yarn-config.sh" ]]; then</span><br><span class="line">  . "$&#123;HADOOP_LIBEXEC_DIR&#125;/yarn-config.sh"</span><br><span class="line">else</span><br><span class="line">  echo "ERROR: Cannot execute $&#123;HADOOP_LIBEXEC_DIR&#125;/yarn-config.sh." 2&gt;&amp;1</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> stop nodemanager</span><br><span class="line">echo "Stopping nodemanagers"</span><br><span class="line">hadoop_uservar_su yarn nodemanager "$&#123;HADOOP_YARN_HOME&#125;/bin/yarn" \</span><br><span class="line">    --config "$&#123;HADOOP_CONF_DIR&#125;" \</span><br><span class="line">    --workers \</span><br><span class="line">    --daemon stop \</span><br><span class="line">    nodemanager</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> stop resourceManager</span><br><span class="line">HARM=$("$&#123;HADOOP_HDFS_HOME&#125;/bin/hdfs" getconf -confKey yarn.resourcemanager.ha.enabled 2&gt;&amp;-)</span><br><span class="line">if [[ $&#123;HARM&#125; = "false" ]]; then</span><br><span class="line">  echo "Stopping resourcemanager"</span><br><span class="line">  hadoop_uservar_su yarn resourcemanager "$&#123;HADOOP_YARN_HOME&#125;/bin/yarn" \</span><br><span class="line">      --config "$&#123;HADOOP_CONF_DIR&#125;" \</span><br><span class="line">      --daemon stop \</span><br><span class="line">      resourcemanager</span><br><span class="line">else</span><br><span class="line">  logicals=$("$&#123;HADOOP_HDFS_HOME&#125;/bin/hdfs" getconf -confKey yarn.resourcemanager.ha.rm-ids 2&gt;&amp;-)</span><br><span class="line">  logicals=$&#123;logicals//,/ &#125;</span><br><span class="line">  for id in $&#123;logicals&#125;</span><br><span class="line">  do</span><br><span class="line">      rmhost=$("$&#123;HADOOP_HDFS_HOME&#125;/bin/hdfs" getconf -confKey "yarn.resourcemanager.hostname.$&#123;id&#125;" 2&gt;&amp;-)</span><br><span class="line">      RMHOSTS="$&#123;RMHOSTS&#125; $&#123;rmhost&#125;"</span><br><span class="line">  done</span><br><span class="line">  echo "Stopping resourcemanagers on [$&#123;RMHOSTS&#125;]"</span><br><span class="line">  hadoop_uservar_su yarn resourcemanager "$&#123;HADOOP_YARN_HOME&#125;/bin/yarn" \</span><br><span class="line">      --config "$&#123;HADOOP_CONF_DIR&#125;" \</span><br><span class="line">      --daemon stop \</span><br><span class="line">      --workers \</span><br><span class="line">      --hostnames "$&#123;RMHOSTS&#125;" \</span><br><span class="line">      resourcemanager</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> stop proxyserver</span><br><span class="line"><span class="meta">#</span> cut用于显式每行特定区间的字符串，-f与-d合用</span><br><span class="line">PROXYSERVER=$("$&#123;HADOOP_HDFS_HOME&#125;/bin/hdfs" getconf -confKey  yarn.web-proxy.address 2&gt;&amp;- | cut -f1 -d:)</span><br><span class="line">if [[ -n $&#123;PROXYSERVER&#125; ]]; then</span><br><span class="line">  echo "Stopping proxy server [$&#123;PROXYSERVER&#125;]"</span><br><span class="line">  hadoop_uservar_su yarn proxyserver "$&#123;HADOOP_YARN_HOME&#125;/bin/yarn" \</span><br><span class="line">      --config "$&#123;HADOOP_CONF_DIR&#125;" \</span><br><span class="line">      --workers \</span><br><span class="line">      --hostnames "$&#123;PROXYSERVER&#125;" \</span><br><span class="line">      --daemon stop \</span><br><span class="line">      proxyserver</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>start-master.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> Starts the master on the machine this script is executed on.</span><br><span class="line"></span><br><span class="line">if [ -z "$&#123;SPARK_HOME&#125;" ]; then</span><br><span class="line">  export SPARK_HOME="$(cd "`dirname "$0"`"/..; pwd)"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> NOTE: This exact class name is matched downstream by SparkSubmit.</span><br><span class="line"><span class="meta">#</span> Any changes need to be reflected there.</span><br><span class="line">CLASS="org.apache.spark.deploy.master.Master"</span><br><span class="line"></span><br><span class="line">if [[ "$@" = *--help ]] || [[ "$@" = *-h ]]; then</span><br><span class="line">  echo "Usage: ./sbin/start-master.sh [options]"</span><br><span class="line">  pattern="Usage:"</span><br><span class="line">  pattern+="\|Using Spark's default log4j profile:"</span><br><span class="line">  pattern+="\|Registered signal handlers for"</span><br><span class="line"></span><br><span class="line">  "$&#123;SPARK_HOME&#125;"/bin/spark-class $CLASS --help 2&gt;&amp;1 | grep -v "$pattern" 1&gt;&amp;2</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">ORIGINAL_ARGS="$@"</span><br><span class="line"></span><br><span class="line">. "$&#123;SPARK_HOME&#125;/sbin/spark-config.sh"</span><br><span class="line"></span><br><span class="line">. "$&#123;SPARK_HOME&#125;/bin/load-spark-env.sh"</span><br><span class="line"></span><br><span class="line">if [ "$SPARK_MASTER_PORT" = "" ]; then</span><br><span class="line">  SPARK_MASTER_PORT=7077</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ "$SPARK_MASTER_HOST" = "" ]; then</span><br><span class="line">  case `uname` in</span><br><span class="line">      (SunOS)</span><br><span class="line">	  SPARK_MASTER_HOST="`/usr/sbin/check-hostname | awk '&#123;print $NF&#125;'`"</span><br><span class="line">	  ;;</span><br><span class="line">      (*)</span><br><span class="line">      # hostname -f显示主机全域名</span><br><span class="line">	  SPARK_MASTER_HOST="`hostname -f`"</span><br><span class="line">	  ;;</span><br><span class="line">  esac</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ "$SPARK_MASTER_WEBUI_PORT" = "" ]; then</span><br><span class="line">  SPARK_MASTER_WEBUI_PORT=8080</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">"$&#123;SPARK_HOME&#125;/sbin"/spark-daemon.sh start $CLASS 1 \</span><br><span class="line">  --host $SPARK_MASTER_HOST --port $SPARK_MASTER_PORT --webui-port $SPARK_MASTER_WEBUI_PORT \</span><br><span class="line"><span class="meta">  $</span>ORIGINAL_ARGS</span><br></pre></td></tr></table></figure>
<p>spark-daemon.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/usr/bin/env bash</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span> Licensed to the Apache Software Foundation (ASF) under one or more</span><br><span class="line"><span class="meta">#</span> contributor license agreements.  See the NOTICE file distributed with</span><br><span class="line"><span class="meta">#</span> this work for additional information regarding copyright ownership.</span><br><span class="line"><span class="meta">#</span> The ASF licenses this file to You under the Apache License, Version 2.0</span><br><span class="line"><span class="meta">#</span> (the "License"); you may not use this file except in compliance with</span><br><span class="line"><span class="meta">#</span> the License.  You may obtain a copy of the License at</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span>    http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span> Unless required by applicable law or agreed to in writing, software</span><br><span class="line"><span class="meta">#</span> distributed under the License is distributed on an "AS IS" BASIS,</span><br><span class="line"><span class="meta">#</span> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"><span class="meta">#</span> See the License for the specific language governing permissions and</span><br><span class="line"><span class="meta">#</span> limitations under the License.</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Runs a Spark command as a daemon.</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span> Environment Variables</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span>   SPARK_CONF_DIR  Alternate conf dir. Default is $&#123;SPARK_HOME&#125;/conf.</span><br><span class="line"><span class="meta">#</span>   SPARK_LOG_DIR   Where log files are stored. $&#123;SPARK_HOME&#125;/logs by default.</span><br><span class="line"><span class="meta">#</span>   SPARK_MASTER    host:path where spark code should be rsync'd from</span><br><span class="line"><span class="meta">#</span>   SPARK_PID_DIR   The pid files are stored. /tmp by default.</span><br><span class="line"><span class="meta">#</span>   SPARK_IDENT_STRING   A string representing this instance of spark. $USER by default</span><br><span class="line"><span class="meta">#</span>   SPARK_NICENESS The scheduling priority for daemons. Defaults to 0.</span><br><span class="line"><span class="meta">#</span>   SPARK_NO_DAEMONIZE   If set, will run the proposed command in the foreground. It will not output a PID file.</span><br><span class="line"><span class="meta">#</span>#</span><br><span class="line"></span><br><span class="line">usage="Usage: spark-daemon.sh [--config &lt;conf-dir&gt;] (start|stop|submit|status) &lt;spark-command&gt; &lt;spark-instance-number&gt; &lt;args...&gt;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> if no args specified, show usage</span><br><span class="line">if [ $# -le 1 ]; then</span><br><span class="line">  echo $usage</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ -z "$&#123;SPARK_HOME&#125;" ]; then</span><br><span class="line">  export SPARK_HOME="$(cd "`dirname "$0"`"/..; pwd)"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">. "$&#123;SPARK_HOME&#125;/sbin/spark-config.sh"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> get arguments</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Check if --config is passed as an argument. It is an optional parameter.</span><br><span class="line"><span class="meta">#</span> Exit if the argument is not a directory.</span><br><span class="line"></span><br><span class="line">if [ "$1" == "--config" ]</span><br><span class="line">then</span><br><span class="line">  shift</span><br><span class="line">  conf_dir="$1"</span><br><span class="line">  if [ ! -d "$conf_dir" ]</span><br><span class="line">  then</span><br><span class="line">    echo "ERROR : $conf_dir is not a directory"</span><br><span class="line">    echo $usage</span><br><span class="line">    exit 1</span><br><span class="line">  else</span><br><span class="line">    export SPARK_CONF_DIR="$conf_dir"</span><br><span class="line">  fi</span><br><span class="line">  shift</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">option=$1</span><br><span class="line">shift</span><br><span class="line">command=$1</span><br><span class="line">shift</span><br><span class="line">instance=$1</span><br><span class="line">shift</span><br><span class="line"></span><br><span class="line">spark_rotate_log ()</span><br><span class="line">&#123;</span><br><span class="line">    log=$1;</span><br><span class="line">    num=5;</span><br><span class="line">    if [ -n "$2" ]; then</span><br><span class="line">	num=$2</span><br><span class="line">    fi</span><br><span class="line">    if [ -f "$log" ]; then # rotate logs</span><br><span class="line">	while [ $num -gt 1 ]; do</span><br><span class="line">	    prev=`expr $num - 1`</span><br><span class="line">	    [ -f "$log.$prev" ] &amp;&amp; mv "$log.$prev" "$log.$num"</span><br><span class="line">	    num=$prev</span><br><span class="line">	done</span><br><span class="line">	mv "$log" "$log.$num";</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">. "$&#123;SPARK_HOME&#125;/bin/load-spark-env.sh"</span><br><span class="line"></span><br><span class="line">if [ "$SPARK_IDENT_STRING" = "" ]; then</span><br><span class="line">  export SPARK_IDENT_STRING="$USER"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">export SPARK_PRINT_LAUNCH_COMMAND="1"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> get log directory</span><br><span class="line">if [ "$SPARK_LOG_DIR" = "" ]; then</span><br><span class="line">  export SPARK_LOG_DIR="$&#123;SPARK_HOME&#125;/logs"</span><br><span class="line">fi</span><br><span class="line">mkdir -p "$SPARK_LOG_DIR"</span><br><span class="line">touch "$SPARK_LOG_DIR"/.spark_test &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">TEST_LOG_DIR=$?</span><br><span class="line">if [ "$&#123;TEST_LOG_DIR&#125;" = "0" ]; then</span><br><span class="line">  rm -f "$SPARK_LOG_DIR"/.spark_test</span><br><span class="line">else</span><br><span class="line">  chown "$SPARK_IDENT_STRING" "$SPARK_LOG_DIR"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ "$SPARK_PID_DIR" = "" ]; then</span><br><span class="line">  SPARK_PID_DIR=/tmp</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> some variables</span><br><span class="line">log="$SPARK_LOG_DIR/spark-$SPARK_IDENT_STRING-$command-$instance-$HOSTNAME.out"</span><br><span class="line">pid="$SPARK_PID_DIR/spark-$SPARK_IDENT_STRING-$command-$instance.pid"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Set default scheduling priority</span><br><span class="line">if [ "$SPARK_NICENESS" = "" ]; then</span><br><span class="line">    export SPARK_NICENESS=0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">execute_command() &#123;</span><br><span class="line">  if [ -z $&#123;SPARK_NO_DAEMONIZE+set&#125; ]; then</span><br><span class="line">      nohup -- "$@" &gt;&gt; $log 2&gt;&amp;1 &lt; /dev/null &amp;</span><br><span class="line">      newpid="$!"</span><br><span class="line"></span><br><span class="line">      echo "$newpid" &gt; "$pid"</span><br><span class="line"></span><br><span class="line">      # Poll for up to 5 seconds for the java process to start</span><br><span class="line">      # &#123;1..10&#125; 1到10</span><br><span class="line">      for i in &#123;1..10&#125;</span><br><span class="line">      do</span><br><span class="line">        if [[ $(ps -p "$newpid" -o comm=) =~ "java" ]]; then</span><br><span class="line">           break</span><br><span class="line">        fi</span><br><span class="line">        sleep 0.5</span><br><span class="line">      done</span><br><span class="line"></span><br><span class="line">      sleep 2</span><br><span class="line">      # Check if the process has died; in that case we'll tail the log so the user can see</span><br><span class="line">      if [[ ! $(ps -p "$newpid" -o comm=) =~ "java" ]]; then</span><br><span class="line">        echo "failed to launch: $@"</span><br><span class="line">        tail -10 "$log" | sed 's/^/  /'</span><br><span class="line">        echo "full log in $log"</span><br><span class="line">      fi</span><br><span class="line">  else</span><br><span class="line">      "$@"</span><br><span class="line">  fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run_command() &#123;</span><br><span class="line">  mode="$1"</span><br><span class="line">  shift</span><br><span class="line"></span><br><span class="line">  mkdir -p "$SPARK_PID_DIR"</span><br><span class="line"></span><br><span class="line">  if [ -f "$pid" ]; then</span><br><span class="line">    TARGET_ID="$(cat "$pid")"</span><br><span class="line">    if [[ $(ps -p "$TARGET_ID" -o comm=) =~ "java" ]]; then</span><br><span class="line">      echo "$command running as process $TARGET_ID.  Stop it first."</span><br><span class="line">      exit 1</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [ "$SPARK_MASTER" != "" ]; then</span><br><span class="line">    echo rsync from "$SPARK_MASTER"</span><br><span class="line">    rsync -a -e ssh --delete --exclude=.svn --exclude='logs/*' --exclude='contrib/hod/logs/*' "$SPARK_MASTER/" "$&#123;SPARK_HOME&#125;"</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  spark_rotate_log "$log"</span><br><span class="line">  echo "starting $command, logging to $log"</span><br><span class="line"></span><br><span class="line">  case "$mode" in</span><br><span class="line">    (class)</span><br><span class="line">      execute_command nice -n "$SPARK_NICENESS" "$&#123;SPARK_HOME&#125;"/bin/spark-class "$command" "$@"</span><br><span class="line">      ;;</span><br><span class="line"></span><br><span class="line">    (submit)</span><br><span class="line">      execute_command nice -n "$SPARK_NICENESS" bash "$&#123;SPARK_HOME&#125;"/bin/spark-submit --class "$command" "$@"</span><br><span class="line">      ;;</span><br><span class="line"></span><br><span class="line">    (*)</span><br><span class="line">      echo "unknown mode: $mode"</span><br><span class="line">      exit 1</span><br><span class="line">      ;;</span><br><span class="line">  esac</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case $option in</span><br><span class="line"></span><br><span class="line">  (submit)</span><br><span class="line">    run_command submit "$@"</span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line">  (start)</span><br><span class="line">    run_command class "$@"</span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line">  (stop)</span><br><span class="line"></span><br><span class="line">    if [ -f $pid ]; then</span><br><span class="line">      TARGET_ID="$(cat "$pid")"</span><br><span class="line">      # ps -p 获取pid，-o comm=获取执行的命令列</span><br><span class="line">      # =~匹配后面的正则表达式</span><br><span class="line">      if [[ $(ps -p "$TARGET_ID" -o comm=) =~ "java" ]]; then</span><br><span class="line">        echo "stopping $command"</span><br><span class="line">        kill "$TARGET_ID" &amp;&amp; rm -f "$pid"</span><br><span class="line">      else</span><br><span class="line">        echo "no $command to stop"</span><br><span class="line">      fi</span><br><span class="line">    else</span><br><span class="line">      echo "no $command to stop"</span><br><span class="line">    fi</span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line">  (status)</span><br><span class="line"></span><br><span class="line">    if [ -f $pid ]; then</span><br><span class="line">      TARGET_ID="$(cat "$pid")"</span><br><span class="line">      if [[ $(ps -p "$TARGET_ID" -o comm=) =~ "java" ]]; then</span><br><span class="line">        echo $command is running.</span><br><span class="line">        exit 0</span><br><span class="line">      else</span><br><span class="line">        echo $pid file is present but $command not running</span><br><span class="line">        exit 1</span><br><span class="line">      fi</span><br><span class="line">    else</span><br><span class="line">      echo $command not running.</span><br><span class="line">      exit 2</span><br><span class="line">    fi</span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line">  (*)</span><br><span class="line">    echo $usage</span><br><span class="line">    exit 1</span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://www.runoob.com/linux/linux-shell.html" target="_blank" rel="noopener">Shell 教程</a></p>
<p><a href="https://www.runoob.com/linux/linux-command-manual.html" target="_blank" rel="noopener">Linux 命令大全</a></p>
<p><a href="https://www.cnblogs.com/image-eye/archive/2011/08/20/2147153.html" target="_blank" rel="noopener">Shell编程中Shift的用法</a></p>
<p><a href="https://blog.csdn.net/heybeaman/article/details/89499537" target="_blank" rel="noopener">shell 用command 命令</a></p>
<p><a href="https://git-scm.com/docs/git-rev-parse" target="_blank" rel="noopener">git-rev-parse</a></p>
<p><a href="https://blog.csdn.net/qq_28391549/article/details/79202417" target="_blank" rel="noopener">shell local命令</a></p>
<p><a href="https://www.cnblogs.com/guixiaoming/p/8507268.html" target="_blank" rel="noopener">curl 命令详解~~</a></p>
<p><a href="https://www.cnblogs.com/lsdb/p/7171779.html" target="_blank" rel="noopener">curl和wget的区别和使用</a></p>
<p><a href="https://www.cnblogs.com/zhoul/p/9939601.html" target="_blank" rel="noopener">wget命令详解</a></p>
<p><a href="https://blog.csdn.net/xxiaozr/article/details/80012741" target="_blank" rel="noopener">Shell: BASH_SOURCE</a></p>
<p><a href="https://www.jianshu.com/p/40ee783b5aa4" target="_blank" rel="noopener">cd</a></p>
<p><a href="https://www.douban.com/note/404726254/" target="_blank" rel="noopener">(21). ps -o comm= -p $$ 查看你使用的shell</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Shell/" rel="tag"># Shell</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/08/200608Log4j2实践/" rel="next" title="Log4j2实践">
                <i class="fa fa-chevron-left"></i> Log4j2实践
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/06/10/200610设计数据仓库/" rel="prev" title="设计数据仓库">
                设计数据仓库 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="Hopeful Nick" />
            
              <p class="site-author-name" itemprop="name">Hopeful Nick</p>
              <p class="site-description motion-element" itemprop="description">To Explore</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">87</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">35</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/hopefulnick" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:lh848764@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">1.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hopeful Nick</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://hopefulnick.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://hopefulnick.github.io/2020/06/09/200609Shell实战/';
          this.page.identifier = '2020/06/09/200609Shell实战/';
          this.page.title = 'Shell实战';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://hopefulnick.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
